name: provision
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ww3-api/**
      - anurag-sh/**
      - weather-api/**
      - cloudflare/**
      - azure/**
      - aws/**
      - tfc/**
      - maccas-api/**
      - places-api/**
      - replybot/**
      - redis-cluster/**
      - sandbox/**
      - graph/**
      - openai/**
      - upstash/**
      - module/**
      - ozb/**
      - .github/workflows/call-terraform.yml
      - .github/workflows/provision.yml

concurrency:
  group: environment-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  tfc:
    uses: ./.github/workflows/call-terraform.yml
    with:
      directory: tfc
    secrets: inherit

  upstash:
    uses: ./.github/workflows/call-terraform.yml
    with:
      directory: upstash
    secrets: inherit
    needs: tfc

  redis-cluster:
    uses: ./.github/workflows/call-terraform-fly-io.yml
    with:
      directory: redis-cluster
    secrets: inherit
    needs: tfc

  cloud:
    name: ${{ matrix.directory }}
    uses: ./.github/workflows/call-terraform.yml
    with:
      directory: ${{ matrix.directory }}
    secrets: inherit
    needs:
      - tfc
      - upstash
      - redis-cluster

    strategy:
      fail-fast: false
      matrix:
        directory:
          - azure
          - aws
          - cloudflare

  shared:
    name: ${{ matrix.directory }}
    uses: ./.github/workflows/call-terraform.yml
    with:
      directory: ${{ matrix.directory }}
    secrets: inherit
    needs: cloud

    strategy:
      fail-fast: false
      matrix:
        directory:
          - places-api
          - graph
          - openai

  projects:
    name: ${{ matrix.directory }}
    uses: ./.github/workflows/call-terraform.yml
    with:
      directory: ${{ matrix.directory }}
    secrets: inherit
    needs:
      - shared

    strategy:
      fail-fast: false
      matrix:
        directory:
          - anurag-sh
          - ww3-api
          - weather-api
          - sandbox
          - maccas-api
          - replybot
          - ozb
