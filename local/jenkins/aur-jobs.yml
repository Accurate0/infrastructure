- job-template:
    name: "{package}"
    defaults: aur
    properties:
      - copyartifact:
          projects: "aur-update"
    node: archlinux-docker
    wrappers:
      - workspace-cleanup
      - ansicolor
    scm:
      - git:
          url: "https://aur.archlinux.org/{package}.git"
          branches:
            - "*/master"
          skip-tag: true
    triggers:
      - pollscm:
          cron: "@hourly"
    builders:
      - shell: |
          #!/bin/bash -ex
          sudo pacman -Syu --noconfirm
          makepkg --nosign --syncdeps --noconfirm
    publishers:
      - archive:
          artifacts: "*.pkg.tar.zst"
          allow-empty: "false"
          only-if-success: true
      - trigger-parameterized-builds:
          - project: "aur-update"
            current-parameters: true
            condition: "SUCCESS"
            fail-on-missing: true
            predefined-parameters: "UPSTREAM_PROJECT=$JOB_NAME"

- job:
    name: linux-xanmod
    defaults: aur
    properties:
      - copyartifact:
          projects: "aur-update"
    node: archlinux-docker
    wrappers:
      - workspace-cleanup
      - ansicolor
    scm:
      - git:
          url: "https://aur.archlinux.org/linux-xanmod.git"
          branches:
            - "*/master"
          skip-tag: true
    triggers:
      - pollscm:
          cron: "@hourly"
    builders:
      - shell: |
          #!/bin/bash -ex
          mkdir -p "$HOME/.config"

          wget https://kernel.anurag.sh/modules -O "$HOME/.config/modprobed.db"
          wget https://kernel.anurag.sh/config -O myconfig

          sudo pacman -Syu --noconfirm
          env _microarchitecture=15 use_numa=n use_tracers=n _localmodcfg=y makepkg -s --noconfirm --skippgpcheck --skipinteg --skipchecksums
    publishers:
      - archive:
          artifacts: "*.pkg.tar.zst, config.last"
          allow-empty: "false"
          only-if-success: true
      - trigger-parameterized-builds:
          - project: "aur-update"
            current-parameters: true
            condition: "SUCCESS"
            fail-on-missing: true
            predefined-parameters: "UPSTREAM_PROJECT=$JOB_NAME"

- job:
    name: "aur-update"
    defaults: aur
    node: archlinux-repo-update
    parameters:
      - string:
          name: UPSTREAM_PROJECT
          description: |
            Package to add to the repo
    builders:
      - copyartifact:
          project: "${UPSTREAM_PROJECT}"
          filter: "**/*.pkg.tar.zst"
          target: $WORKSPACE
          which-build: last-successful

      - shell: |
          #!/bin/bash -ex
          cp "$WORKSPACE"/* /var/data/aur/
          repo-add -p /var/data/aur/aur-packages.db.tar.gz /var/data/aur/*.pkg.tar.zst
          rm -f /var/data/aur/*.old

- job:
    name: aur-packages
    project-type: folder

- defaults:
    name: aur
    folder: aur-packages
    description: |
      Managed by Jenkins Job Builder. Do not edit via web.

- project:
    name: aur
    package: !include: packages.yaml.inc
    jobs:
      - "{package}"
